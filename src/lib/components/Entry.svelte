<script lang="ts">
	import { fade } from 'svelte/transition';
	import dayjs from 'dayjs';
	import { getEntryColour, getHue, setBackgroundGradient } from '$lib/utils/utils';
	import { pb } from '$lib/db/db';
	import { decrypt, unwrapSecretKey } from '$lib/utils/crypto';
	import { key, user } from '$lib/stores/data';
	export let entry;
	export let del;
	export let edit;
	let decrypted = '';
	let failed = false;
	const entryColour = getEntryColour(entry);
	if (entry.iv && $key) {
		decrypt($key, entry.notes, entry.iv).then(val => decrypted = val).catch(e => failed = true);
	}

	const decryptThis = async () => {
		if (!entry.iv) {
			console.log('Not encrypted!');
			return;
		}
		if (!$key) {
			const pw = prompt('Enter a decryption password');
			$key = await unwrapSecretKey($user.key, $user.id, pw);

		}
		decrypt($key, entry.notes, entry.iv).then(val => decrypted = val).catch(e => failed = true);
	}
</script>

{#if entry}
	<article
		class="card p-4"
		style="background: linear-gradient(115deg, {entryColour.luminance(
			0.6
		)} 0%, {entryColour.luminance(0.4)} 35%, {entryColour.luminance(
			0.3
		)} 100%); color: {entryColour.luminance(0.02)}"
	>
		<header class="card-header pt-0 pl-0 relative">
			<div class="float-right flex gap-2 -mr-4 pt-2">
				<svg
					class="w-6 h-6"
					viewBox="0 0 24 24"
					version="1.1"
					xmlns="http://www.w3.org/2000/svg"
					xmlns:xlink="http://www.w3.org/1999/xlink"
					><title>edit_line</title><g
						stroke="none"
						stroke-width="1"
						fill="none"
						fill-rule="evenodd"
						><g id="Editor" transform="translate(-240.000000, 0.000000)" fill-rule="nonzero"
							><g id="edit_line" transform="translate(240.000000, 0.000000)"
								><path
									d="M24,0 L24,24 L0,24 L0,0 L24,0 Z M12.5934901,23.257841 L12.5819402,23.2595131 L12.5108777,23.2950439 L12.4918791,23.2987469 L12.4918791,23.2987469 L12.4767152,23.2950439 L12.4056548,23.2595131 C12.3958229,23.2563662 12.3870493,23.2590235 12.3821421,23.2649074 L12.3780323,23.275831 L12.360941,23.7031097 L12.3658947,23.7234994 L12.3769048,23.7357139 L12.4804777,23.8096931 L12.4953491,23.8136134 L12.4953491,23.8136134 L12.5071152,23.8096931 L12.6106902,23.7357139 L12.6232938,23.7196733 L12.6232938,23.7196733 L12.6266527,23.7031097 L12.609561,23.275831 C12.6075724,23.2657013 12.6010112,23.2592993 12.5934901,23.257841 L12.5934901,23.257841 Z M12.8583906,23.1452862 L12.8445485,23.1473072 L12.6598443,23.2396597 L12.6498822,23.2499052 L12.6498822,23.2499052 L12.6471943,23.2611114 L12.6650943,23.6906389 L12.6699349,23.7034178 L12.6699349,23.7034178 L12.678386,23.7104931 L12.8793402,23.8032389 C12.8914285,23.8068999 12.9022333,23.8029875 12.9078286,23.7952264 L12.9118235,23.7811639 L12.8776777,23.1665331 C12.8752882,23.1545897 12.8674102,23.1470016 12.8583906,23.1452862 L12.8583906,23.1452862 Z M12.1430473,23.1473072 C12.1332178,23.1423925 12.1221763,23.1452606 12.1156365,23.1525954 L12.1099173,23.1665331 L12.0757714,23.7811639 C12.0751323,23.7926639 12.0828099,23.8018602 12.0926481,23.8045676 L12.108256,23.8032389 L12.3092106,23.7104931 L12.3186497,23.7024347 L12.3186497,23.7024347 L12.3225043,23.6906389 L12.340401,23.2611114 L12.337245,23.2485176 L12.337245,23.2485176 L12.3277531,23.2396597 L12.1430473,23.1473072 Z"
									id="MingCute"
									fill-rule="nonzero"
								/><path
									d="M13,3 C13.5523,3 14,3.44772 14,4 C14,4.51283143 13.613973,4.93550653 13.1166239,4.9932722 L13,5 L5,5 L5,19 L19,19 L19,11 C19,10.4477 19.4477,10 20,10 C20.51285,10 20.9355092,10.386027 20.9932725,10.8833761 L21,11 L21,19 C21,20.0543909 20.18415,20.9181678 19.1492661,20.9945144 L19,21 L5,21 C3.94563773,21 3.08183483,20.18415 3.00548573,19.1492661 L3,19 L3,5 C3,3.94563773 3.81587733,3.08183483 4.85073759,3.00548573 L5,3 L13,3 Z M19.2426,3.34334 C19.6331,2.95281 20.2663,2.95281 20.6568,3.34334 C21.0172615,3.70382 21.0449893,4.27105503 20.7399834,4.6633435 L20.6568,4.75755 L10.7573,14.657 C10.3668,15.0476 9.73363,15.0476 9.34311,14.657 C8.98262077,14.2965385 8.95489083,13.7293645 9.25992018,13.3370224 L9.34311,13.2428 L19.2426,3.34334 Z"
									fill="currentColor"
								/></g
							></g
						></g
					></svg
				>
				{#if del}<button
						class="transition-colors hover:text-[#ffffff88] w-6 h-6"
						on:click={() => del(entry)}
						><svg
							class="w-6 h-6"
							viewBox="0 0 24 24"
							version="1.1"
							xmlns="http://www.w3.org/2000/svg"
							xmlns:xlink="http://www.w3.org/1999/xlink"
							><title>close_circle_line</title><g
								stroke="none"
								stroke-width="1"
								fill="none"
								fill-rule="evenodd"
								><g id="System" transform="translate(-240.000000, 0.000000)" fill-rule="nonzero"
									><g id="close_circle_line" transform="translate(240.000000, 0.000000)"
										><path
											d="M24,0 L24,24 L0,24 L0,0 L24,0 Z M12.5934901,23.257841 L12.5819402,23.2595131 L12.5108777,23.2950439 L12.4918791,23.2987469 L12.4918791,23.2987469 L12.4767152,23.2950439 L12.4056548,23.2595131 C12.3958229,23.2563662 12.3870493,23.2590235 12.3821421,23.2649074 L12.3780323,23.275831 L12.360941,23.7031097 L12.3658947,23.7234994 L12.3769048,23.7357139 L12.4804777,23.8096931 L12.4953491,23.8136134 L12.4953491,23.8136134 L12.5071152,23.8096931 L12.6106902,23.7357139 L12.6232938,23.7196733 L12.6232938,23.7196733 L12.6266527,23.7031097 L12.609561,23.275831 C12.6075724,23.2657013 12.6010112,23.2592993 12.5934901,23.257841 L12.5934901,23.257841 Z M12.8583906,23.1452862 L12.8445485,23.1473072 L12.6598443,23.2396597 L12.6498822,23.2499052 L12.6498822,23.2499052 L12.6471943,23.2611114 L12.6650943,23.6906389 L12.6699349,23.7034178 L12.6699349,23.7034178 L12.678386,23.7104931 L12.8793402,23.8032389 C12.8914285,23.8068999 12.9022333,23.8029875 12.9078286,23.7952264 L12.9118235,23.7811639 L12.8776777,23.1665331 C12.8752882,23.1545897 12.8674102,23.1470016 12.8583906,23.1452862 L12.8583906,23.1452862 Z M12.1430473,23.1473072 C12.1332178,23.1423925 12.1221763,23.1452606 12.1156365,23.1525954 L12.1099173,23.1665331 L12.0757714,23.7811639 C12.0751323,23.7926639 12.0828099,23.8018602 12.0926481,23.8045676 L12.108256,23.8032389 L12.3092106,23.7104931 L12.3186497,23.7024347 L12.3186497,23.7024347 L12.3225043,23.6906389 L12.340401,23.2611114 L12.337245,23.2485176 L12.337245,23.2485176 L12.3277531,23.2396597 L12.1430473,23.1473072 Z"
											fill-rule="nonzero"
										/><path
											d="M12,2 C17.5228,2 22,6.47715 22,12 C22,17.5228 17.5228,22 12,22 C6.47715,22 2,17.5228 2,12 C2,6.47715 6.47715,2 12,2 Z M12,4 C7.58172,4 4,7.58172 4,12 C4,16.4183 7.58172,20 12,20 C16.4183,20 20,16.4183 20,12 C20,7.58172 16.4183,4 12,4 Z M9.87874,8.46443 L12,10.5857 L14.1213,8.46441 C14.5118,8.07388 15.145,8.07388 15.5355,8.46441 C15.926,8.85493 15.926,9.4881 15.5355,9.87862 L13.4142,11.9999 L15.5356,14.1213 C15.9261,14.5118 15.9261,15.145 15.5356,15.5355 C15.1451,15.926 14.5119,15.926 14.1214,15.5355 L12,13.4141 L9.87864,15.5355 C9.48812,15.926 8.85496,15.926 8.46443,15.5355 C8.07391,15.145 8.07391,14.5118 8.46443,14.1213 L10.5858,11.9999 L8.46452,9.87864 C8.074,9.48812 8.074,8.85496 8.46452,8.46443 C8.85505,8.07391 9.48821,8.07391 9.87874,8.46443 Z"
											fill="currentColor"
										/></g
									></g
								></g
							></svg
						>
					</button>{/if}
			</div>
			<h2>{dayjs(entry.date).format('dddd DD MMMM YYYY')}</h2>
			<small
				>{dayjs(entry.date).format('HH:mm')}
				{#if edit}Edit{/if}
			</small>
		</header>
		<div class="py-2">
			{#if decrypted}
				{decrypted}
			{:else}
				{#if !entry.iv}
					{entry.notes}
				{:else if failed}
					Decryption failed.
				{:else}
				<div class="flex flex-col justify-center items-center" on:click={decryptThis}>
				<svg width='24px' height='24px' viewBox='0 0 24 24' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><title>unlock_line</title><g stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'><g id='System' transform='translate(-478.000000, -192.000000)' fill-rule='nonzero'><g id='unlock_line' transform='translate(478.000000, 192.000000)'><path d='M24,0 L24,24 L0,24 L0,0 L24,0 Z M12.5934901,23.257841 L12.5819402,23.2595131 L12.5108777,23.2950439 L12.4918791,23.2987469 L12.4918791,23.2987469 L12.4767152,23.2950439 L12.4056548,23.2595131 C12.3958229,23.2563662 12.3870493,23.2590235 12.3821421,23.2649074 L12.3780323,23.275831 L12.360941,23.7031097 L12.3658947,23.7234994 L12.3769048,23.7357139 L12.4804777,23.8096931 L12.4953491,23.8136134 L12.4953491,23.8136134 L12.5071152,23.8096931 L12.6106902,23.7357139 L12.6232938,23.7196733 L12.6232938,23.7196733 L12.6266527,23.7031097 L12.609561,23.275831 C12.6075724,23.2657013 12.6010112,23.2592993 12.5934901,23.257841 L12.5934901,23.257841 Z M12.8583906,23.1452862 L12.8445485,23.1473072 L12.6598443,23.2396597 L12.6498822,23.2499052 L12.6498822,23.2499052 L12.6471943,23.2611114 L12.6650943,23.6906389 L12.6699349,23.7034178 L12.6699349,23.7034178 L12.678386,23.7104931 L12.8793402,23.8032389 C12.8914285,23.8068999 12.9022333,23.8029875 12.9078286,23.7952264 L12.9118235,23.7811639 L12.8776777,23.1665331 C12.8752882,23.1545897 12.8674102,23.1470016 12.8583906,23.1452862 L12.8583906,23.1452862 Z M12.1430473,23.1473072 C12.1332178,23.1423925 12.1221763,23.1452606 12.1156365,23.1525954 L12.1099173,23.1665331 L12.0757714,23.7811639 C12.0751323,23.7926639 12.0828099,23.8018602 12.0926481,23.8045676 L12.108256,23.8032389 L12.3092106,23.7104931 L12.3186497,23.7024347 L12.3186497,23.7024347 L12.3225043,23.6906389 L12.340401,23.2611114 L12.337245,23.2485176 L12.337245,23.2485176 L12.3277531,23.2396597 L12.1430473,23.1473072 Z'  fill-rule='nonzero'></path><path d='M12,2 C13.0914,2 14.1174,2.29247 15.0008,2.80367 C15.4789,3.08027 15.6421,3.69202 15.3655,4.17005 C15.0889,4.64807 14.4772,4.81136 13.9992,4.53476 C13.4118,4.19488 12.7302,4 12,4 C9.79086,4 8,5.79086 8,8 L19,8 C20.1046,8 21,8.89543 21,10 L21,20 C21,21.1046 20.1046,22 19,22 L5,22 C3.89543,22 3,21.1046 3,20 L3,10 C3,8.89543 3.89543,8 5,8 L6,8 C6,4.68629 8.68629,2 12,2 Z M19,10 L5,10 L5,20 L19,20 L19,10 Z M12,12 C13.1046,12 14,12.8954 14,14 C14,14.6833538 13.657297,15.286613 13.1343876,15.6473597 L13,15.7324 L13,17 C13,17.5523 12.5523,18 12,18 C11.48715,18 11.0644908,17.613973 11.0067275,17.1166239 L11,17 L11,15.7324 C10.4022,15.3866 10,14.7403 10,14 C10,12.8954 10.8954,12 12,12 Z M19.9182,5.02123 L20.8842,5.28005 C21.4176,5.42299 21.7342,5.97133 21.5913,6.50479 C21.4483,7.03826 20.9,7.35484 20.3665,7.2119 L19.4006,6.95308 C18.8671,6.81014 18.5506,6.2618 18.6935,5.72833 C18.8364,5.19487 19.3848,4.87829 19.9182,5.02123 Z M18.6334,2.08878 C19.1669,2.23172 19.4835,2.78005 19.3405,3.31352 L19.2111,3.79648 C19.0682,4.32995 18.5199,4.64653 17.9864,4.50359 C17.4529,4.36065 17.1363,3.81231 17.2793,3.27884 L17.4087,2.79588 C17.5516,2.26242 18.1,1.94583 18.6334,2.08878 Z' fill='currentColor'></path></g></g></g></svg>
					<p>Decrypt?</p>
				</div>
			{/if}
		{/if}</div>
		{#if entry.attachments}
			<div class="grid grid-cols-3 pb-4">
			{#each entry.attachments as attachment}
			{@const img = pb.getFileUrl(entry, attachment)}
				<a href={img} target="_blank"><img src={img} class="rounded-xl shadow aspect-video object-cover" /></a>
			{/each}
			</div>
		{/if}
		<div class="flex flex-wrap gap-2">
			{#each entry.expand.emotions as emotion}
				<span
					style="background-color: hsl({getHue(emotion)} 90% 30%); color: hsl({getHue(
						emotion
					)} 80% 100%);"
					class="badge">{emotion.name}</span
				>
			{/each}
		</div>
	</article>
{/if}
